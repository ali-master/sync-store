global
    log 127.0.0.1 local0
    log 127.0.0.1 local1 notice
    maxconn 4096
    user haproxy
    group haproxy
    daemon
    tune.ssl.default-dh-param 2048
    # Enable stats socket for runtime API commands
    stats socket /var/run/haproxy.sock mode 600 expose-fd listeners level admin

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    retries 3
    timeout connect 10s
    timeout client  30m
    timeout server  30m
    timeout check   10s
    maxconn 3000

# Frontend configuration for MariaDB Galera Cluster
frontend galera_front
    bind *:3306
    default_backend galera_back

# Stats page configuration
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE
    stats show-legends
    stats show-node

# Backend configuration for MariaDB Galera Cluster
backend galera_back
    mode tcp
    option tcpka
    balance leastconn
    timeout server  30m
    # Sticky connections: maintains the connection affinity
    stick-table type string len 32 size 100k expire 30m
    stick on dst

    # Health check for all servers
    option mysql-check user haproxy_check

    # Distribute queries across all nodes (R/W)
    # MariaDB node 1
    server mariadb1 mariadb1:3306 check weight 100 inter 2s rise 2 fall 3 maxconn 1000
    # MariaDB node 2
    server mariadb2 mariadb2:3306 check weight 100 inter 2s rise 2 fall 3 maxconn 1000 backup
    # MariaDB node 3
    server mariadb3 mariadb3:3306 check weight 100 inter 2s rise 2 fall 3 maxconn 1000 backup

# Dedicated backend for read-only operations (optional - can be used with a separate frontend port)
backend galera_read
    mode tcp
    option tcpka
    balance roundrobin
    timeout server 30m
    option mysql-check user haproxy_check

    # All nodes serve read operations
    server mariadb1 mariadb1:3306 check weight 100 inter 2s rise 2 fall 3 maxconn 1000
    server mariadb2 mariadb2:3306 check weight 100 inter 2s rise 2 fall 3 maxconn 1000
    server mariadb3 mariadb3:3306 check weight 100 inter 2s rise 2 fall 3 maxconn 1000
